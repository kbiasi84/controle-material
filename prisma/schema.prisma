generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---

enum Perfil {
  USUARIO       // Operacional (BOP) - Retirar material para si mesmo
  CONTROLADOR   // Gestão Local (BOP/PEL) - Retirar/Devolver para terceiros
  GESTOR        // Gestão Completa (CIA/BPRv/CPRv) - Cadastrar, Transferir, Relatórios, Admin
}

enum StatusMaterial {
  DISPONIVEL
  EM_USO
  MANUTENCAO
  INATIVO
}

// --- MODELOS ---

model Unidade {
  id        Int      @id @default(autoincrement())
  nome      String   @unique
  sigla     String?  // Ex: "BOP", "PEL", "CIA", "BPRv", "CPRv"
  endereco  String?
  createdAt DateTime @default(now())

  // Hierarquia Organizacional (Auto-relacionamento)
  unidadeSuperiorId Int?
  unidadeSuperior   Unidade?  @relation("Hierarquia", fields: [unidadeSuperiorId], references: [id])
  subordinadas      Unidade[] @relation("Hierarquia")

  // Relacionamentos
  usuarios              Usuario[]
  materiais             Material[]
  transferenciasOrigem  Transferencia[] @relation("OrigemUnidade")
  transferenciasDestino Transferencia[] @relation("DestinoUnidade")
}

model TipoMaterial {
  id        Int        @id @default(autoincrement())
  nome      String     @unique // Ex: "Etilômetro", "Taser"
  
  materiais Material[]
}

model Usuario {
  id            Int     @id @default(autoincrement())
  identificacao String  @unique // Login
  nome          String
  senha         String 
  perfil        Perfil  @default(USUARIO)
  ativo         Boolean @default(true)
  
  unidadeId     Int
  unidade       Unidade @relation(fields: [unidadeId], references: [id])

  // Logs
  movimentacoesFeitas    Movimentacao[] @relation("Beneficiario")
  retiradasAutorizadas   Movimentacao[] @relation("ResponsavelRetirada")
  devolucoesAutorizadas  Movimentacao[] @relation("ResponsavelDevolucao")
  transferenciasRealizadas Transferencia[]
}

model Material {
  id                  Int            @id @default(autoincrement())
  codigoIdentificacao String         @unique
  descricao           String         // Detalhe fixo do bem
  status              StatusMaterial @default(DISPONIVEL)
  
  // O que está acontecendo agora com o material (Ex: "Tela quebrada")
  // Deve ser limpo quando o status voltar a ser DISPONIVEL
  observacaoAtual     String?        

  // FKs
  unidadeId           Int
  unidade             Unidade        @relation(fields: [unidadeId], references: [id])
  tipoId              Int
  tipo                TipoMaterial   @relation(fields: [tipoId], references: [id])

  movimentacoes       Movimentacao[]
  transferencias      Transferencia[]
}

model Movimentacao {
  id             Int       @id @default(autoincrement())
  dataRetirada   DateTime  @default(now())
  dataDevolucao  DateTime?
  obsRetirada    String?
  obsDevolucao   String?   // Histórico do que aconteceu
  
  materialId     Int
  material       Material  @relation(fields: [materialId], references: [id])

  usuarioId      Int
  usuario        Usuario   @relation("Beneficiario", fields: [usuarioId], references: [id])

  respRetiradaId Int
  respRetirada   Usuario   @relation("ResponsavelRetirada", fields: [respRetiradaId], references: [id])

  respDevolucaoId Int?
  respDevolucao   Usuario?  @relation("ResponsavelDevolucao", fields: [respDevolucaoId], references: [id])
}

model Transferencia {
  id                Int      @id @default(autoincrement())
  dataTransferencia DateTime @default(now())
  observacao        String?

  materialId        Int
  material          Material @relation(fields: [materialId], references: [id])

  origemId          Int
  origem            Unidade  @relation("OrigemUnidade", fields: [origemId], references: [id])

  destinoId         Int
  destino           Unidade  @relation("DestinoUnidade", fields: [destinoId], references: [id])

  responsavelId     Int
  responsavel       Usuario  @relation(fields: [responsavelId], references: [id])
}
